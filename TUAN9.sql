USE TUAN9
CREATE DATABASE QLBH_1
ON PRIMARY
( NAME = 'QuanlyBH', FILENAME = 'D:\BTSQL\QuanlyBH.mdf' , SIZE = 4048KB , MAXSIZE =
10240KB , FILEGROWTH = 20%)
LOG ON
( NAME = 'QLBH_log', FILENAME = 'D:\BTSQL\QLBH_log.ldf' , SIZE = 1024KB , MAXSIZE =
10240KB , FILEGROWTH = 10%)
USE TUAN9

CREATE TABLE NhomSanPham
(	MaNhom INT PRIMARY KEY NOT NULL, 
	TenNhom NVARCHAR(15) NULL)

CREATE TABLE SanPham
(	MaSp INT PRIMARY KEY NOT NULL, 
	TenSp NVARCHAR(40) NOT NULL,
	Donvitinh NVARCHAR(20) NULL, 
	GiaGoc MONEY NULL, 
	SLTON INT NULL,
	MaNhom INT NULL, 
	MaNCC INT NULL, 
	MoTa NVARCHAR(50) NULL)

CREATE TABLE HoaDon
(	MaHD INT PRIMARY KEY NOT NULL,
	NgayLapHD DATETIME NULL,
	MaKh NCHAR(5) NULL,
	NgayGiao DATETIME NULL,
	Noichuyen NVARCHAR(60) NOT NULL,
	MaNV INT NULL)

CREATE TABLE CT_HoaDon
(	MaHD INT NOT NULL,
	MaSp INT NOT NULL,
	Dongia MONEY NULL,
	Soluong SMALLINT NULL,
	ChietKhau MONEY NULL,
PRIMARY KEY CLUSTERED
(
 [MaHD] ASC,
 [MaSp] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, 
ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]) 
ON [PRIMARY]

CREATE TABLE NhaCungCap
(	MaNCC INT PRIMARY KEY NOT NULL, 
	TenNcc NVARCHAR(40) NOT NULL, 
	Diachi NVARCHAR(60) NULL, 
	Phone NVARCHAR(24) NULL, 
	SoFax NVARCHAR(24) NULL, 
	DCMail NVARCHAR(50)NULL)

CREATE TABLE KhachHang
(	MaKH NCHAR(5) PRIMARY KEY NOT NULL, 
	TenKh NVARCHAR(40) NOT NULL,
	Diachi NVARCHAR(60) NULL, 
	Phone NVARCHAR(24) NULL,
	LoaiKh NVARCHAR(3) NULL,  
	SoFax NVARCHAR(24) NULL, 
	DCMail NVARCHAR(50) NULL, 
	DiemTL INT NULL)

CREATE TABLE NhanVien
(	MaNV INT PRIMARY KEY, 
	TenNV NVARCHAR(40) NOT NULL, 
	Diachi NVARCHAR(60) NULL, 
	Phone NVARCHAR(60) NULL)

ALTER TABLE HoaDon  WITH CHECK ADD FOREIGN KEY (MaKH) REFERENCES KhachHang (MaKh)
ALTER TABLE HoaDon  WITH CHECK ADD FOREIGN KEY (MaNV) REFERENCES NhanVien (MaNV)
ALTER TABLE CT_HoaDon  WITH CHECK ADD FOREIGN KEY (MaHD) REFERENCES HoaDon (MaHD)
ALTER TABLE CT_HoaDon WITH CHECK ADD FOREIGN KEY (MaSp) REFERENCES SanPham (MaSp)
ALTER TABLE SanPham WITH CHECK ADD FOREIGN KEY (MaNhom) REFERENCES NhomSanPham (MaNhom)
ALTER TABLE SanPham WITH CHECK ADD FOREIGN KEY (MaNCC) REFERENCES NhaCungCap (MaNCC)
ALTER TABLE SanPham WITH CHECK ADD CONSTRAINT [SP_CK_1] CHECK (([Giagoc]>(0)))
ALTER TABLE SanPham CHECK CONSTRAINT [SP_CK_1]
ALTER TABLE SanPham WITH CHECK ADD CONSTRAINT [SP_CK_2] CHECK (([SLTON]>(0)))
ALTER TABLE SanPham CHECK CONSTRAINT [SP_CK_2]
ALTER TABLE HoaDon WITH CHECK ADD CONSTRAINT [HD_CK] CHECK (([NgayLapHD]>= GETDATE()))
ALTER TABLE HoaDon CHECK CONSTRAINT [HD_CK]
ALTER TABLE CT_HoaDon WITH CHECK ADD CONSTRAINT [CTHD_CK_1] CHECK (([Soluong]>(0)))
ALTER TABLE CT_HoaDon CHECK CONSTRAINT [CTHD_CK_1]
ALTER TABLE CT_HoaDon WITH CHECK ADD CONSTRAINT [CTHD_CK_2] CHECK (([ChietKhau]>(0)))
ALTER TABLE CT_HoaDon CHECK CONSTRAINT [CTHD_CK_2]
ALTER TABLE KhachHang WITH CHECK ADD CONSTRAINT [KH_CK_1] CHECK (([LoaiKh]='VIP' OR [LoaiKh]='TV' OR [LoaiKh]='VL'))
ALTER TABLE KhachHang CHECK CONSTRAINT [KH_CK_1]  
ALTER TABLE KhachHang WITH CHECK ADD CONSTRAINT [KH_CK_2] CHECK (([DiemTL]>=(0)))
ALTER TABLE HoaDon ADD LoaiHD CHAR(1)
ALTER TABLE HoaDon WITH CHECK ADD CONSTRAINT [CT_HoaDon_CK_3] CHECK (([LoaiHD]='N' OR [LoaiHD]='X' OR [LoaiHD]='C'))
ALTER TABLE HoaDon WITH CHECK ADD CONSTRAINT [DF_HoaDon_LoaiHD] DEFAULT 'N' FOR LoaiHD
ALTER TABLE HoaDon ADD CONSTRAINT [HD_CK_3] CHECK (([NgayGiao]>=[NgayLapHD]))

--TUAN 9 
--1) Xóa hết các dữ liệu đang có trong các Table của cơ sở dữ liệu QLBH bằng lệnh
--Delete
DELETE FROM CT_HoaDon
DELETE FROM HoaDon
DELETE FROM SanPham
DELETE FROM NhomSanPham
DELETE FROM NhaCungCap
DELETE FROM KhachHang
DELETE FROM NhanVien

--2) Trong trường hợp nào thì không xóa được dữ liệu bảng SanPham khi chưa xóa
--dữ liệu bảng con của SanPham?

--3) Nếu bạn muốn xóa bất kỳ Bảng cha thì xóa luôn các bảng quan hệ thì bạn phải
--làm gì? Bạn thực hiện một ví dụ minh họa


--4) Dùng lệnh Insert thêm vào mỗi bảng của CSDL QLBH 5 record với nội dung do
--sinh viên tự nghĩ
INSERT INTO NhomSanPham(MaNhom, TenNhom) VALUES
(1, 'RAU'),
(2, 'KEO'),
(3, 'QUA'),
(4, 'HOA'),
(5, 'THIT'),
(6, 'CA')

INSERT INTO NhaCungCap (MaNCC, TenNcc, Diachi, Phone, SoFax, DCMail) VALUES
(1, 'A-FARM', 'LONG AN', '0933684518', '65748', 'ACFARM@GMAIL.COM'),
(2, 'AC-FARM', 'LONG AN', '0642388322', '62268', 'ACTFARM@GMAIL.COM'),
(3, 'AT-FARM', 'DONG THAP', '0291882128', '65733', 'ATFARM@GMAIL.COM'),
(4, 'MO-FARM', 'USA', '0933664518', '65741', 'MOFARM@GMAIL.COM'),
(5, 'MOT-FARM', 'USA', '0233664518', '65740', 'MOTFARM@GMAIL.COM')

INSERT INTO SanPham (MaSp, TenSp, MaNCC, MoTa, MaNhom, Donvitinh, GiaGoc, SLTON) VALUES
(1, 'XA LACH', 2, NULL, 1, 'KG', 20000, 50),
(2, 'CU KHOAI TAY', 1, NULL, 1, 'KG', 30000, 50),
(3, 'RAU CAI', 1, NULL, 2, 'KG', 40000, 20),
(4, 'THITHEO', 3, NULL, 3, 'BO', 100000, 50),
(5, 'HOA HONG', 2, NULL, 5, 'KG', 70000, 100)

INSERT INTO SanPham (MaSp, TenSp, MaNCC, MoTa, MaNhom, Donvitinh, GiaGoc, SLTON) VALUES
(6, 'CA CHE BIEN', 1, NULL, 6, 'BOX', 220000, 50),
(7, 'CA TRE', 1, NULL, 6, 'BOX', 250000, 50),
(8, 'CU MI', 1, NULL, 2, 'CU', 250000, 9),
(9, 'CA TRA', 1, NULL, 6, 'CON', 300000, 3),
(10, 'CU KHOAI LANG', 4, NULL, 2, 'CU', 200000, 9),
(11, 'CA MU', 4, NULL, 6, 'CON', 300000, 3)

INSERT INTO KhachHang(MaKh, TenKh, LoaiKh, DiaChi, Phone, SoFax, DCMail, DiemTL) VALUES
('Kh001', 'NGUYEN TRAN HA NHU', 'VIP', 'Q1-TP.HCM', '0352498400', '181020', 'hahu0415@gmail.com', 10),
('Kh002', 'NGUYEN DUC LONG', 'TV', 'TP.HCM', '0367288199', '203050', 'lonhs033@gmail.com', 50),
('Kh003', 'KAGEAMA', 'VL', 'LONDON', '0983136121', '09876', 'KAE@GMAIL.COM', 100),
('Kh004', 'KAETO', 'VIP', 'ANH', '0982323213', '09875', 'KGET@GMAIL.COM', 90),
('Kh005', 'HINTA', 'TV', 'PHAP', '0935454651', '09874', 'HIN@GMAIL.COM', 10),
('Kh006', 'HIN', 'VL', 'MY', '0954545453', '09873', 'HNO@GMAIL.COM', 0)

INSERT INTO Nhanvien (MaNV, TenNV, DiaChi, Phone) VALUES 
('001', 'NGUYEN VAN MINH', 'PHU NHUAN', '0987265146'),
('002', 'NGUYEN KIM CHI', 'GO VAP', '0139284439'),
('003', 'NGUYEN KIM THAO', 'TAN PHU', '0823893821'),
('004', 'NGUYEN KIM HOA', 'BINH TAN', '0783494839'),
('005', 'NGUYEN HOA QUYNH', 'THU DUC', '0901120456'),
('006', 'NGUYEN XUAN SANG', 'PHU NHUAN', '0902530811')

ALTER TABLE HoaDon DROP CONSTRAINT HD_CK_3

INSERT INTO HoaDon (MaHD, MaNV, NgayLapHD, NgayGiao, Noichuyen, MaKh, LoaiHD) VALUES
(1, '001', '1996-11-28', '1996-12-1', 'LONG AN', 'Kh001', 'X'),
(2, '002', '1996-11-29', '1996-12-2', 'CA MAU', 'Kh002', 'X'),
(3, '003', '1997-2-11', '1997-1-20', 'AN GIANG', 'Kh002', 'X'),
(4, '004', '1997-1-11', '1997-2-20', 'DONG THAP', 'Kh001', 'X'),
(5, '005', '1997-07-29', '1997-08-01', 'BINH PHUOC', 'Kh001', 'X'),
(6, '006', '1997-07-30', '1997-08-05', 'LONG AN', 'Kh005', 'X')

ALTER TABLE CT_HoaDon DROP CONSTRAINT CTHD_CK_2

INSERT INTO CT_HoaDon(MaHD, MaSp, Soluong, Dongia, ChietKhau) VALUES
(1, 3, '10',35000, 0),
(2, 2, '10',45000, 0),
(3, 5, '20',70000, 0),
(4, 4, '5',110000, 10000),
(5, 10, '6',300000, 0),
(6, 11, '3',400000, 0)

--BÀI TẬP 2: LỆNH UPDATE

UPDATE SanPham SET GiaGoc = 100000 WHERE TenSp LIKE 'T%'

SELECT SanPham.MaSp, SanPham.TenSp, SanPham.GiaGoc
FROM SanPham
WHERE SanPham.TenSp LIKE 'T%'

UPDATE SanPham SET SLTON = SLTON * 0.5 WHERE Donvitinh LIKE '%BOX%'

SELECT SanPham.MaSp, SanPham.TenSp, SanPham.Donvitinh, SanPham.SLTON
FROM SanPham
WHERE SanPham.Donvitinh LIKE '%BOX%'

UPDATE NhaCungCap SET MaNCC = 100 WHERE MaNCC = 1
----> Không cập nhập được do vi phạm ràng buộc với bảng sản phẩm có (MaNCC)

UPDATE KhachHang SET DiemTL = DiemTL + 100
WHERE MaKH IN (SELECT DISTINCT MaKH FROM HoaDon 
WHERE MONTH(HoaDon.NgayLapHD) = 7 AND YEAR(HoaDon.NgayLapHD) = 1997) 

SELECT KhachHang.MaKH, KhachHang.TenKh, KhachHang.DiemTL
FROM KhachHang
INNER JOIN HoaDon ON KhachHang.MaKH = HoaDon.MaKh
WHERE MONTH(HoaDon.NgayLapHD) = 7 AND YEAR(HoaDon.NgayLapHD) = 1997 

UPDATE SanPham SET GiaGoc = GiaGoc * 0.9 WHERE SLTON < 10

SELECT SanPham.MaSp, SanPham.TenSp, SanPham.GiaGoc, SanPham.SLTON
FROM SanPham
WHERE SanPham.SLTON < 10

UPDATE CT_HoaDon SET Dongia = SanPham.GiaGoc
FROM CT_HoaDon
INNER JOIN SanPham ON CT_HoaDon.MaSp = SanPham.MaSp
WHERE SanPham.MaNCC IN (4, 7)

SELECT CT_HoaDon.MaHD, CT_HoaDon.MaSp, CT_HoaDon.Dongia, SanPham.GiaGoc, SanPham.MaNCC
FROM CT_HoaDon
INNER JOIN SanPham ON CT_HoaDon.MaSp = SanPham.MaSp
WHERE SanPham.MaNCC IN (4,7)


--BÀI TẬP 3: LỆNH DELETE

DELETE FROM CT_HoaDon
WHERE MaHD IN (SELECT MaHD FROM HoaDon
WHERE MONTH(NgayLapHD) = 7 AND YEAR(NgayLapHD) = 1996)

DELETE FROM HoaDon
WHERE MONTH(NgayLapHD) = 7 AND YEAR(NgayLapHD) = 1996

DELETE FROM CT_HoaDon
WHERE MaHD IN (SELECT MaHD FROM HoaDon 
INNER JOIN KhachHang ON HoaDon.MaKh = KhachHang.MaKH
WHERE KhachHang.LoaiKh = 'VL' AND YEAR(HoaDon.NgayLapHD) = 1996)

DELETE FROM HoaDon
WHERE MaHD IN (SELECT MaHD FROM HoaDon
INNER JOIN KhachHang ON HoaDon.MaKh = KhachHang.MaKH
WHERE KhachHang.LoaiKh = 'VL' AND YEAR(HoaDon.NgayLapHD) = 1996)

DELETE FROM SanPham
WHERE MaSp NOT IN (SELECT DISTINCT MaSp FROM HoaDon 
INNER JOIN CT_HoaDon ON HoaDon.MaHD = CT_HoaDon.MaHD
WHERE YEAR(HoaDon.NgayLapHD) = 1996)

DELETE FROM CT_HoaDon
WHERE MaHD IN (SELECT MaHD FROM HoaDon 
INNER JOIN KhachHang ON HoaDon.MaKh = KhachHang.MaKH 
WHERE KhachHang.LoaiKh = 'VL')

DELETE FROM HoaDon
WHERE MaKh IN (SELECT MaKh FROM KhachHang
WHERE LoaiKh = 'VL');
DELETE FROM KhachHang WHERE LoaiKh = 'VL'

SELECT * INTO HoaDon797
FROM HoaDon
WHERE MONTH(NgayLapHD) = 7 AND YEAR(NgayLapHD) = 1997

TRUNCATE TABLE HoaDon797